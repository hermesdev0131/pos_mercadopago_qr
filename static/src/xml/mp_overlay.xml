<?xml version="1.0" encoding="UTF-8"?>
<templates id="mp_qr_templates" xml_declaration="False">

    <!-- Overlay component -->
    <t t-name="pos_mercadopago_qr.MPOverlay">
        <div class="mpqr-overlay d-flex align-items-center justify-content-center"
             style="position:absolute; inset:0; background:rgba(0,0,0,0.7); z-index:9999;">
            <div class="mpqr-card bg-white p-4 rounded-4 text-center" style="min-width:320px;">
                <h3 style="color:#0099ff;">MercadoPago</h3>

                <!-- idle -->
                <t t-if="mpState.status == 'idle'">
                    <button class="btn btn-primary w-100" t-on-click.prevent="startMP">
                        Generate QR
                    </button>
                </t>

                <!-- loading -->
                <t t-if="mpState.status == 'loading'">
                    <i class="fa fa-spinner fa-spin fa-3x"/>
                    <p>Connecting...</p>
                </t>

                <!-- pending -->
                <t t-if="mpState.status == 'pending'">
                    <img t-att-src="mpState.qr_url"
                         style="width:220px;height:220px;object-fit:contain;border:1px solid #ccc;border-radius:8px;"/>
                    <p>Scan the QR with MercadoPago</p>
                </t>

                <!-- approved -->
                <t t-if="mpState.status == 'approved'">
                    <i class="fa fa-check-circle fa-4x text-success"/>
                    <h4>Payment Approved</h4>
                    <button class="btn btn-success w-100" t-on-click="hideMPOverlay">OK</button>
                </t>

                <!-- error -->
                <t t-if="mpState.status == 'error'">
                    <i class="fa fa-exclamation-triangle fa-3x text-danger"/>
                    <p><t t-esc="mpState.error"/></p>
                    <button class="btn btn-secondary w-100" t-on-click="() => mpState.status = 'idle'">Retry</button>
                </t>
            </div>
        </div>
    </t>

    <!-- Inject overlay into PaymentScreen -->
    <t t-name="pos_mercadopago_qr.PaymentScreenOverlay"
       t-inherit="point_of_sale.PaymentScreen"
       t-inherit-mode="extension">

        <!-- Ensure screen is position:relative -->
        <xpath expr="//div[hasclass('payment-screen')]" position="attributes">
            <attribute name="style">position:relative;</attribute>
        </xpath>

        <!-- Insert overlay at end -->
        <xpath expr="//div[hasclass('payment-screen')]" position="inside">
            <t t-if="mpState and mpState.visible">
                <t t-call="pos_mercadopago_qr.MPOverlay" t-pass="*"/>
            </t>
        </xpath>

    </t>

</templates>
