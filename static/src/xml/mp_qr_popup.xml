<?xml version="1.0" encoding="UTF-8"?>
<templates id="mp_qr_templates" xml:space="preserve">

    <!-- Full-screen MercadoPago QR Popup Component -->
    <t t-name="pos_mercadopago_qr.MPQRPopup" owl="1">
        <div class="mpqr-backdrop" t-on-click.stop="">
            <div class="mpqr-card" t-on-click.stop="">
                
                <!-- Header with MercadoPago branding -->
                <div class="mpqr-header">
                    <div class="mpqr-logo">
                        <i class="fa fa-credit-card mpqr-logo-icon"/>
                    </div>
                    <h2 class="mpqr-title">Mercado Pago</h2>
                </div>

                <!-- IDLE STATE: Show generate QR button -->
                <t t-if="props.status === 'idle'">
                    <div class="mpqr-content mpqr-idle">
                        <div class="mpqr-idle-icon">
                            <i class="fa fa-qrcode"/>
                        </div>
                        <p class="mpqr-idle-text">
                            Presione el botón para generar el código QR<br/>
                            y procesar el pago con Mercado Pago
                        </p>
                        
                        <!-- Amount preview -->
                        <div class="mpqr-amount-container">
                            <div class="mpqr-amount-label">Monto a cobrar</div>
                            <div class="mpqr-amount-value">
                                $ <t t-esc="props.amount"/>
                            </div>
                        </div>
                        
                        <button class="mpqr-btn mpqr-btn-primary" t-on-click="props.onStart">
                            <i class="fa fa-qrcode"/>
                            Generar QR
                        </button>
                        <button class="mpqr-btn mpqr-btn-cancel" t-on-click="props.onCancel">
                            <i class="fa fa-times"/>
                            Cancelar
                        </button>
                    </div>
                </t>

                <!-- LOADING STATE: Connecting to MercadoPago -->
                <t t-if="props.status === 'loading'">
                    <div class="mpqr-content mpqr-loading">
                        <div class="mpqr-spinner"/>
                        <p class="mpqr-loading-text">Conectando con Mercado Pago...</p>
                    </div>
                </t>

                <!-- PENDING STATE: Show QR code and wait for payment -->
                <t t-if="props.status === 'pending'">
                    <div class="mpqr-content">
                        <!-- QR Code -->
                        <div class="mpqr-qr-container">
                            <img t-att-src="props.qr_url" 
                                 class="mpqr-qr-image"
                                 alt="QR Code"/>
                        </div>
                        
                        <!-- Status message -->
                        <div class="mpqr-status mpqr-status-pending">
                            <i class="fa fa-refresh mpqr-status-icon"/>
                            Esperando pago...
                        </div>
                        
                        <!-- Amount -->
                        <div class="mpqr-amount-container">
                            <div class="mpqr-amount-label">Monto a cobrar</div>
                            <div class="mpqr-amount-value">
                                $ <t t-esc="props.amount"/>
                            </div>
                        </div>
                        
                        <button class="mpqr-btn mpqr-btn-cancel" t-on-click="props.onCancel">
                            <i class="fa fa-times"/>
                            Cancelar Pago
                        </button>
                    </div>
                </t>

                <!-- APPROVED STATE: Payment successful -->
                <t t-if="props.status === 'approved'">
                    <div class="mpqr-content mpqr-success">
                        <div class="mpqr-success-icon">
                            <i class="fa fa-check"/>
                        </div>
                        <h3 class="mpqr-success-title">¡Pago Aprobado!</h3>
                        <p class="mpqr-success-subtitle">
                            El pago se ha procesado correctamente
                        </p>
                        
                        <!-- Amount paid -->
                        <div class="mpqr-amount-container">
                            <div class="mpqr-amount-label">Monto cobrado</div>
                            <div class="mpqr-amount-value">
                                $ <t t-esc="props.amount"/>
                            </div>
                        </div>
                        
                        <button class="mpqr-btn mpqr-btn-success" t-on-click="props.onNewOrder">
                            <i class="fa fa-plus"/>
                            Nueva Orden
                        </button>
                        <button class="mpqr-btn mpqr-btn-cancel" t-on-click="props.onClose">
                            <i class="fa fa-check"/>
                            Cerrar
                        </button>
                    </div>
                </t>

                <!-- ERROR STATE: Show error with retry option -->
                <t t-if="props.status === 'error'">
                    <div class="mpqr-content mpqr-error">
                        <div class="mpqr-error-icon">
                            <i class="fa fa-exclamation-triangle"/>
                        </div>
                        <h3 class="mpqr-error-title">Error en el Pago</h3>
                        <p class="mpqr-error-message">
                            <t t-esc="props.error or 'Ha ocurrido un error al procesar el pago.'"/>
                        </p>
                        
                        <button class="mpqr-btn mpqr-btn-primary" t-on-click="props.onRetry">
                            <i class="fa fa-refresh"/>
                            Intentar de Nuevo
                        </button>
                        <button class="mpqr-btn mpqr-btn-cancel" t-on-click="props.onCancel">
                            <i class="fa fa-times"/>
                            Cancelar
                        </button>
                    </div>
                </t>

                <!-- Footer -->
                <div class="mpqr-footer">
                    <i class="fa fa-lock mpqr-footer-icon"/>
                    <span class="mpqr-footer-text">Pago seguro con Mercado Pago</span>
                </div>

            </div>
        </div>
    </t>

    <!-- Inject popup inside PaymentScreen -->
    <t t-name="pos_mercadopago_qr.PaymentScreenPatch"
       t-inherit="point_of_sale.PaymentScreen"
       t-inherit-mode="extension">

        <!-- Ensure payment-screen has a layout that can host the popup -->
        <xpath expr="//div[contains(@class, 'main-content')]" position="attributes">
            <attribute name="style">position:relative;</attribute>
        </xpath>

        <!-- Add the popup at the end of the screen -->
        <xpath expr="//div[contains(@class, 'main-content')]" position="after">
            <t t-if="mpqrPopupProps">
                <MPQRPopup t-props="mpqrPopupProps"/>
            </t>
        </xpath>
    </t>

</templates>
